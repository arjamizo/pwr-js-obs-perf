<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>AngularJS â€¢ To do app</title>
    <script src="../bower_components/angular/angular.js"></script>
    <script src="https://rawgithub.com/gsklee/ngStorage/master/ngStorage.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.9/angular-route.js"></script>
    
    <script type="text/javascript">
        var _ = {};
        _.range = function(start, stop, step) {
            if (stop == null) {
                stop = start || 0;
                start = 0;
            }
            step = step || 1;

            var length = Math.max(Math.ceil((stop - start) / step), 0);
            var range = Array(length);

            for (var idx = 0; idx < length; idx++, start += step) {
                range[idx] = start;
            }

            return range;
        };
        _.copy = function( src, dest) {
            if (!src || !dest) return;
            for (var i in Object.keys(src)) {
                dest[i]=src[i];
            }
        }
        _.empty = function(obj) {
            for(var i in Object.keys(obj)) {
                delete obj[i];
            }
        }
        'use strict';
        var m=angular.module("todoapp", ['ngStorage', 'ngRoute']);
        // window.m=m;
        
        m.factory("todosModel", function($localStorage) {
            $localStorage.$storage = $localStorage.$default({
                todos: []
            });
            return $localStorage.$storage.todos;
        })
        
        m.controller("todoctrl", function($scope, $log, todosModel, $localStorage, $routeParams) {
            
            console.log('toods', todosModel, 'arg', $routeParams, $routeParams.arg)
            $scope.todos = todosModel;
            window.$digest = $scope.$digest.bind($scope);
            
            $scope.addTodo = function(title, keeptitle) {
                $scope.todos.push({title: title});
                if(!keeptitle) 
                    $scope.title="";
            };
            
            $scope.removeTodo = function(todo) {
                $scope.todos.splice($scope.todos.indexOf(todo), 1);
            };
            
            // $scope.ls = $localStorage.$default({saveToLS: true}) || {saveToLS: false};
            
            $scope.$watch('ls.saveToLS', function(val) {
                // if(!val) todosModel = [];
                // $scope.todos = (val && todosModel) || _todos; 
            })

            // if(location.hash) {
            //     var lh=location.hash.substr(1).split(';');
            //     lh=lh.map(function(e){return e.split(/[(), ]+/)});
            //     var handlers = {
            //         'add': function(number) {
            //             var toAdd = number*1==number?_.range(0, number):number;
            //             document.body.start = window.performance.now();
            //             $scope.todos.push.apply($scope.todos, toAdd);
            //             $timeout(function(scope) {
            //                 console.log("done", document.getElementsByTagName('li').length>=number);
            //                 document.body.end = window.performance.now();
            //                 console.info("time: ", document.body.end-document.body.start);
            //             }, 0)
            //         }
            //     }
            //     var cpy;
            //     lh=lh.map(function(e){return handlers[e[0]].apply(null, (cpy=e, cpy.splice(1)))});
            //     console.log(lh)
            // }
        });
        
        // if(0) 
        m.config(function($routeProvider) { // $provide
            
            console.log('ee', $routeProvider)
            
            $routeProvider.when('/add', {controller: 'todoctrl', template: '123'});
            $routeProvider.when('/add/:arg', {controller: 'todoctrl', template: '234'});
            $routeProvider.otherwise({redirectTo: '/add'});
            
            // $provide.decorator('todoctrl', function($delegate, $log, $routeParams) {
            //     if($routeParams.arg) {
            //         $log('routecalled');
            //     }
            //     $log('decorator');
            // })
        })
        
        setTimeout(function() {
            // var todos = angular.injector(['todoapp', 'ng']).get('todos');
            // todos.push({title: "added always on startup"});
            window.$digest();
        }, 2000);
        //could use http://stackoverflow.com/a/20664122/781312 but angular.run is exec too early
    </script>
</head>
<body ng-app="todoapp">
    <div ng-controller="todoctrl">
        <ul>
            <li ng-repeat="todo in todos"><input type="checkbox" ng-model="todo.completed"/>{{todo.title}}<button ng-click="removeTodo(todo)">&#x2717;</button></li>
        </ul>
        <input ng-model="title" ng-keyup="$event.keyCode==13 && addTodo(title)"/>
        <button ng-click="addTodo(title, keeptitle)">add</button>
        (Keep title after adding: <input type="checkbox" checked="checked" ng-model="keeptitle"/>)
        (Save to localstorage: <input type="checkbox" ng-model="ls.saveToLS">)
        <button ng-click="localStorage.removeItem('ngStorage-todos') && $log.info('cleared LS') && todos.splice(0, todos.length)">clear localStorage</button>
        <div ng-view></div>
    </div>
</body>
</html>